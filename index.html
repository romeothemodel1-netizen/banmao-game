<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Banmao Clicker – Pool V1</title>

<!-- Ethers v6 từ cdnjs + fallback sang unpkg -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"
        onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/ethers@6.13.2/dist/ethers.umd.min.js';document.head.appendChild(s);}())"></script>

<style>
  :root { --yellow:#ffd84d; }
  html,body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .card{background:#111;border:1px solid #222;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .pill{background:#1a1a1a;border:1px solid #222;padding:8px 12px;border-radius:999px}
  .btn{background:var(--yellow);color:#111;border:0;padding:10px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  h1{margin:0 0 10px 0;font-size:22px}
  canvas{width:100%;height:auto;background:linear-gradient(180deg,#161616 0%,#0f0f0f 100%);border-radius:12px;border:1px solid #222;display:block}
  .progress-wrap{margin-top:12px;background:#1a1a1a;border-radius:8px;overflow:hidden;border:1px solid #222}
  .progress-bar{height:20px;background:var(--yellow);width:0%;transition:width 0.2s ease}
  .progress-text{text-align:center;font-size:13px;margin-top:4px;color:#ccc}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Banmao Clicker – Pool V1</h1>
      <div>
        <select id="walletSelect" class="pill">
          <option value="auto">Auto (OKX / MetaMask)</option>
          <option value="okx">Force OKX Wallet</option>
          <option value="metamask">Force MetaMask</option>
        </select>
        <button id="connect" class="btn">Connect Wallet</button>
        <button id="claim" class="btn">Claim BANMAO</button>
      </div>
    </div>
    <div class="row" style="margin-top:-6px;gap:10px">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">BANMAO earned: <b id="earned">0</b></div>
      <div class="pill">Wallet: <span id="addr">not connected</span></div>
      <div class="pill">Balance: <b id="balance">0</b></div>
      <div class="pill">Status: <span id="status">Ready</span></div>
    </div>
    <canvas id="game" width="900" height="460" style="margin-top:12px"></canvas>

    <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
    <div id="progressText" class="progress-text">0 / 333 BANMAO</div>
  </div>
</div>

<script>
  // ====== ONCHAIN CONFIG ======
  const TOKEN_ADDR = "0x16d91d1615fC55b76d5F92365BD60C069b46ef78";
  const GAME_ADDR  = "0x0bb69c08a71e4d2297Fb07f95d2d9c6801937143";
  const MAX_BANMAO = 333;
  const XLAYER_CHAIN_ID_HEX = "0xC4"; // 196

  const GAME_ABI = [
    "function claimReward(uint256 score) external",
    "function claimed(address) view returns (bool)"
  ];
  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)"
  ];

  // ====== UI refs ======
  const walletSelect = document.getElementById("walletSelect");
  const connectBtn = document.getElementById("connect");
  const claimBtn   = document.getElementById("claim");
  const addrEl   = document.getElementById("addr");
  const balEl    = document.getElementById("balance");
  const statusEl = document.getElementById("status");

  // ====== Helpers ======
  function pickInjected(mode="auto"){
    const okx = window.okxwallet?.ethereum || window.okxwallet || null;
    const mm  = window.ethereum || null;
    if (mode==="okx") return okx;
    if (mode==="metamask") return mm;
    return okx || mm;
  }

  async function ensureXLayer(injected){
    try{
      const id = await injected.request({ method: "eth_chainId" });
      if (id === XLAYER_CHAIN_ID_HEX) return;
      await injected.request({ method:"wallet_switchEthereumChain", params:[{ chainId: XLAYER_CHAIN_ID_HEX }] });
    }catch(e){
      if (e?.code===4902){
        await injected.request({ method:"wallet_addEthereumChain", params:[{
          chainId: XLAYER_CHAIN_ID_HEX,
          chainName: "X Layer Mainnet",
          rpcUrls: ["https://rpc.xlayer.tech"],
          nativeCurrency: { name:"OKB", symbol:"OKB", decimals:18 },
          blockExplorerUrls:["https://www.oklink.com/xlayer"]
        }]} );
      } else throw e;
    }
  }

  function waitForEthers(){
    return new Promise(resolve=>{
      const tick=()=>{ if (window.ethers) resolve(); else setTimeout(tick,150); };
      tick();
    });
  }

  // ====== Runtime state ======
  let provider, signer, account, tokenDecimals=18;

  // ====== Connect (KHÔNG phụ thuộc ethers để bật popup) ======
  connectBtn.onclick = async () => {
    try{
      statusEl.textContent = "🔎 Tìm ví...";
      const injected = pickInjected(walletSelect.value);
      if (!injected){ alert("❌ Không thấy ví (MetaMask/OKX). Cài extension rồi refresh."); statusEl.textContent="No wallet"; return; }

      statusEl.textContent = "🧾 Yêu cầu quyền...";
      const accounts = await injected.request({ method:"eth_requestAccounts" });
      account = accounts?.[0];
      if (!account){ statusEl.textContent = "No account"; return; }

      statusEl.textContent = "🔁 Kiểm tra mạng...";
      await ensureXLayer(injected);

      // Chỉ cần ethers từ đây trở đi
      await waitForEthers();
      provider = new ethers.BrowserProvider(injected);
      signer   = await provider.getSigner();

      addrEl.textContent = account.slice(0,6)+'...'+account.slice(-4);
      statusEl.textContent = "✅ Connected";
      await updateBalance();
      await checkClaimed();
    }catch(err){
      console.error("CONNECT_ERR:", err);
      statusEl.textContent = "❌ " + (err?.shortMessage || err?.message || err);
      alert("Connect error: " + (err?.message || err));
    }
  };

  async function updateBalance(){
    try{
      if (!provider || !account) return;
      const token = new ethers.Contract(TOKEN_ADDR, ERC20_ABI, provider);
      tokenDecimals = await token.decimals();
      const bal = await token.balanceOf(account);
      balEl.textContent = ethers.formatUnits(bal, tokenDecimals);
    }catch(e){ balEl.textContent="—"; }
  }

  async function checkClaimed(){
    try{
      if (!provider || !account) return;
      const game = new ethers.Contract(GAME_ADDR, GAME_ABI, provider);
      const done = await game.claimed(account);
      if (done){ statusEl.textContent="✅ Already claimed"; claimBtn.disabled=true; }
      else { statusEl.textContent="Ready to claim"; claimBtn.disabled=false; }
    }catch(e){ /* ignore */ }
  }

  // ====== Claim: 10 điểm = 1 BANMAO, nguyên số, cap 333 ======
  claimBtn.onclick = async () => {
    try{
      if (!signer) return alert("Connect wallet first!");
      const banmaoNow = score/10;
      if (banmaoNow < 1) return alert("Need at least 1 BANMAO to claim!");
      const amount = Math.min(MAX_BANMAO, Math.floor(banmaoNow));

      const game = new ethers.Contract(GAME_ADDR, GAME_ABI, signer);
      const tx = await game.claimReward(amount);
      statusEl.textContent = "⏳ Tx: "+tx.hash;
      claimBtn.disabled = true;
      await tx.wait();
      statusEl.textContent = "✅ Claim succeeded ("+amount+" BANMAO)";
      await updateBalance();
      await checkClaimed();
    }catch(e){
      statusEl.textContent = "❌ "+(e?.shortMessage||e?.reason||e?.message||e);
      claimBtn.disabled = false;
    }
  };

  // ====== Mini-game (đầu mèo) ======
  let score = 0;
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  let banana = { x: 720, y: 220, r: 34, vx: 1.1, vy: 0.9 };

  function drawCatHead(){
    const x = 200, y = 250, r = 60;
    ctx.fillStyle='#ffd84d';
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.moveTo(x-r*0.6, y-r*0.3); ctx.lineTo(x-r*0.2, y-r*1.0); ctx.lineTo(x-r*0.05, y-r*0.3); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(x+r*0.6, y-r*0.3); ctx.lineTo(x+r*0.2, y-r*1.0); ctx.lineTo(x+r*0.05, y-r*0.3); ctx.closePath(); ctx.fill();
    ctx.fillStyle='#111';
    ctx.beginPath(); ctx.arc(x-r*0.35, y-r*0.1, 6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+r*0.35, y-r*0.1, 6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.moveTo(x-5,y+10); ctx.lineTo(x+5,y+10); ctx.lineTo(x,y+16); ctx.closePath(); ctx.fill();
    ctx.strokeStyle='#111'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(x-5,y+20,7,0,Math.PI); ctx.arc(x+5,y+20,7,0,Math.PI); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x-20,y+5);  ctx.lineTo(x-45,y);    ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x-20,y+12); ctx.lineTo(x-45,y+15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x+20,y+5);  ctx.lineTo(x+45,y);    ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x+20,y+12); ctx.lineTo(x+45,y+15); ctx.stroke();
  }

  function drawBanana(){
    ctx.strokeStyle = '#ffd84d'; ctx.lineWidth = 18; ctx.beginPath();
    ctx.arc(banana.x, banana.y, banana.r, Math.PI*0.12, Math.PI*1.12); ctx.stroke();
    ctx.fillStyle = '#ffd84d'; ctx.beginPath();
    ctx.arc(banana.x + banana.r*Math.cos(Math.PI*0.12), banana.y + banana.r*Math.sin(Math.PI*0.12), 6, 0, Math.PI*2); ctx.fill();
  }

  function drawBG(){
    ctx.fillStyle='#121212'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#1a1a1a'; ctx.lineWidth=1;
    for(let x=0;x<canvas.width;x+=32){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
    for(let y=0;y<canvas.height;y+=32){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  }

  function animate(){
    drawBG(); drawCatHead(); drawBanana();
    banana.x += banana.vx; banana.y += banana.vy;
    if(banana.x > canvas.width-40 || banana.x < 40) banana.vx *= -1;
    if(banana.y > canvas.height-40 || banana.y < 40) banana.vy *= -1;
    requestAnimationFrame(animate);
  } animate();

  // Progress bar
  function updateProgress(banmaoNow){
    const bar = document.getElementById('progressBar');
    const txt = document.getElementById('progressText');
    const pct = Math.min(100, (banmaoNow/MAX_BANMAO)*100);
    bar.style.width = pct+"%";
    txt.textContent = banmaoNow.toFixed(3)+" / "+MAX_BANMAO+" BANMAO";
  }

  function hit(mx,my,obj){ const dx=mx-obj.x, dy=my-obj.y; return Math.hypot(dx,dy) <= obj.r + 20; }
  canvas.addEventListener('click', (e)=>{
    const r = canvas.getBoundingClientRect();
    const mx = (e.clientX - r.left) * (canvas.width/r.width);
    const my = (e.clientY - r.top) * (canvas.height/r.height);
    if (hit(mx,my,banana)){
      const v = 10;
      let banmaoNow = (score+v)/10;
      if(banmaoNow > MAX_BANMAO){ 
        statusEl.textContent = "🚫 Max cap "+MAX_BANMAO+" BANMAO";
        return;
      }
      score += v;
      document.getElementById('score').textContent = score;
      document.getElementById('earned').textContent = (score/10).toFixed(3);
      updateProgress(score/10);
      banana.r = 40; setTimeout(()=> banana.r=34,120);
    }
  });
</script>
</body>
</html>
